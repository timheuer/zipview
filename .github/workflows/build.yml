name: Build and Publish

on:
    workflow_dispatch:
        branches:
            - main
        paths-ignore:
            - "**/*.md"
            - "**/*.gitignore"
            - "**/*.gitattributes"
    push:
        branches:
            - main
        paths-ignore:
            - "**/*.md"
            - "**/*.gitignore"
            - "**/*.gitattributes"

jobs:
    build:
        permissions:
            contents: write
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: ğŸ“¦ Install dependencies
              run: npm install

            - name: ğŸ Install vsce
              run: npm install -g @vscode/vsce

            - name: ğŸ–¥ï¸ Install cross-env
              run: npm install -g cross-env

            - name: ğŸ“œ Generate Changelog
              uses: orhun/git-cliff-action@v4
              id: changelog
              with:
                  config: cliff.toml
                  args: --verbose
              env:
                  OUTPUT: CHANGELOG.md
                  GITHUB_REPO: ${{ github.repository }}

            - name: ğŸ“ Commit Changelog
              run: |
                  git config user.name 'github-actions[bot]'
                  git config user.email 'github-actions[bot]@users.noreply.github.com'
                  git add CHANGELOG.md
                  git diff --staged --quiet || git commit -m "chore: update changelog [skip ci]"
                  git push

            - name: ğŸ·ï¸ NBGV
              uses: dotnet/nbgv@master
              id: nbgv
              with:
                  stamp: package.json

            - name: ğŸ—£ï¸ NBGV outputs
              run: |
                  echo "SimpleVersion: ${{ steps.nbgv.outputs.SimpleVersion }}"

            - name: ğŸ“¦ Package
              run: |
                  vsce package -o ./${{ github.event.repository.name}}.vsix

            - name: ğŸ“° Publish
              if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
              run: npm run deploy
              env:
                  VSCE_PAT: ${{ secrets.VSCE_PAT }}

            - name: â¬†ï¸ Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ github.event.repository.name}}.vsix
                  path: ./*.vsix

            - name: ğŸ·ï¸ Tag and Release
              id: tag_release
              uses: softprops/action-gh-release@v1
              with:
                  body: ${{ steps.changelog.outputs.content }}
                  tag_name: ${{ steps.nbgv.outputs.SimpleVersion }}
                  files: ./*.vsix
